"""
–ß–∞—Ç-–±–æ—Ç –¥–ª—è Telegram, –∏–º–∏—Ç–∏—Ä—É—é—â–∏–π —Ü–∏—Ç–∞—Ç—ã –û–º–∞—Ä –•–∞–π—è–º–∞.

–û–º–∞—Ä –•–∞–π—è–º –≤–µ—â–∞–µ—Ç...
@omar_hayyam_bot
http://t.me/omar_hayyam_bot

"""
import asyncio
import logging
import os
import sys
import io
from functools import partial
from PIL.Image import Image
from aiogram import Bot, Dispatcher, executor, types
from concurrent.futures.thread import ThreadPoolExecutor
"""
–ò–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞ generate_quote.py –∏–∑ —Ç–æ–π –∂–µ –ø–∞–ø–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –ø–æ–º–æ—â—å—é –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å—Ä–µ–¥—ã PATH.
–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –∏–º–ø–æ—Ä—Ç, –≤–º–µ—Å—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–≥–æ, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –ø–æ—Å–∫–æ–ª—å–∫—É –∫–æ–¥ –±–æ—Ç–∞ –Ω–µ 
–æ—Ñ–æ—Ä–º–ª–µ–Ω –≤ –≤–∏–¥–µ –º–æ–¥—É–ª—è. PyCharm/VSCode –º–æ–≥—É—Ç –Ω–µ –ø–æ–Ω–∏–º–∞—Ç—å —ç—Ç–æ—Ç —Ö–∞–∫, –ø–æ—ç—Ç–æ–º—É –¥–ª—è –Ω–∏—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç.
"""
sys.path.append(os.path.dirname(__file__))
try:
    from quotes import generate_quote
except ImportError:
    from .quotes import generate_quote


"""
–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–≤–æ–π –∫–ª—é—á –æ—Ç –±–æ—Ç–∞ (–ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ –º–æ–∂–Ω–æ —É @BotFather) –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å—Ä–µ–¥—ã TG_API_KEY –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ —Å—é–¥–∞
–≤—Ä—É—á–Ω—É—é (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è). 
"""
API_TOKEN = os.getenv('TG_API_KEY') or '1234567890'
""" –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ """
MAX_CHARACTERS = 70
""" –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π """
MAX_THREADS = 10

"""
(1) –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
(2) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç
(3) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∏—Å–ø–µ—Ç—á–µ—Ä –±–æ—Ç–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
(4) –°–æ–∑–¥–∞–µ–º –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—É—é –æ—á–µ—Ä–µ–¥—å (thread pool) –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ –Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
"""
logging.basicConfig(level=logging.INFO)
bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot)
thread_pool = ThreadPoolExecutor(max_workers=MAX_THREADS)


@dp.message_handler(commands=['start'])
async def start(message: types.Message):
    """ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start """
    await message.answer(f'üßô ‚Äç–¢—ã –∑–Ω–∞–µ—à—å –º–µ–Ω—è, –∫–∞–∫ —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤–æ–≥–æ –º—ã—Å–ª–∏—Ç–µ–ª—è, –∞ —è –∑–Ω–∞—é, {message.from_user.full_name}, '
                         f'—á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å –º–µ–Ω—è —É–¥–∏–≤–∏—Ç—å!\n\n–ü–æ–¥–µ–ª–∏—Å—å —Å–≤–æ–∏–º–∏ —É–º–Ω—ã–º–∏ –º—ã—Å–ª—è–º–∏ —Å–∫–∞–∂–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –º–Ω–µ... '
                         f'–í–¥—Ä—É–≥ —è —ç—Ç–æ–≥–æ –Ω–µ –≥–æ–≤–æ—Ä–∏–ª? ü§î')


@dp.message_handler()
async def quote(message: types.Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞ –∫–∞–∂–¥—ã–π –ø—Ä–∏—Å–ª–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É —Å —Ü–∏—Ç–∞—Ç–æ–π.

    - async_generate_quote() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ PIL (Pillow)
    - io.BytesIO - —ç—Ç–æ –æ–±—ä–µ–∫—Ç —Ñ–∞–π–ª–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞, –±—É—Ñ–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –≤–º–µ—Å—Ç–æ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã, —Ö—Ä–∞–Ω–∏—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π
      –ø–∞–º—è—Ç–∏. –ë–µ–∑ –¥–∞–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –ø—Ä–∏—à–ª–æ—Å—å –±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª—É–≤—É—é —Å–∏—Å—Ç–µ–º—É –∏ –∑–∞–Ω–æ–≤–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    - –ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—á–∏—Ç–∞–ª–æ—Å—å –∏–∑ –±—É—Ñ–µ—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å, —á—Ç–æ —Å—á–∏—Ç—ã–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω—É–∂–Ω–æ
      —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞: image_io.seek(0)
    - reply_photo() –æ—Ç–ø—Ä–∞–ª—è–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
    """
    logging.info(f'{message.from_user.full_name} –Ω–∞–ø–∏—Å–∞–ª(–∞) "{message.text}"')
    if len(message.text) < MAX_CHARACTERS:
        text = message.text
        image_pil = await async_generate_quote(text)
        image_io = io.BytesIO()
        image_pil.save(image_io, format='JPEG', quality=30)
        image_io.seek(0)
        await message.reply_photo(image_io, caption='–Ø —É–∂–µ —ç—Ç–æ –≥–æ–≤–æ—Ä–∏–ª –æ–¥–Ω–∞–∂–¥—ã.. ‚òù')
    else:
        await message.answer(f'üôÖ‚Äç‚ôÇÔ∏è–ù–µ –Ω—É–∂–Ω–æ –º–Ω–æ–≥–æ —Å–ª–æ–≤... –õ—é–±—ã–µ —Å–ª–æ–≤–∞ –∏–º–µ—é—Ç —Å–≤–æ–π –≤–µ—Å. '
                             f'–ë—É–¥—å –∫—Ä–∞—Ç–æ–∫, 50 —Å–∏–º–≤–æ–ª–æ–≤ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –≤–µ–¥—å —Ä–æ–≤–Ω–æ —Å—Ç–æ–ª—å–∫–æ –∂–µ –∫–∞–ø–ª–µ–π –Ω–∞ –ª–∏—Å—Ç–∫–∞—Ö —Å–∞–∫—É—Ä—ã üå∏')


async def async_generate_quote(text: str) -> Image:
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞–∞—è –æ–±—ë—Ä—Ç–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—É—é –æ—á–µ—Ä–µ–¥—å –∏ –∂–¥—ë—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.

    - get_event_loop() –ø–æ–ª—É—á–∞–µ—Ç —Ü–∏–∫–ª —Å–æ–±—ã—Ç–∏–π (–ø–æ—Ç–æ–∫, –∫–æ—Ç–æ—Ä–æ–º –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞—Å–∏—Ö—Ä–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ - –∫–æ—Ä—É—Ç–∏–Ω—ã)
    - loop.run_in_executor() –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ, –∫–æ—Ç–æ—Ä—ã–º –∏ —è–≤–ª—è–µ—Ç—Å—è –æ—á–µ—Ä–µ–¥—å
    - functools.partial() –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–¥–∞—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã –≤ —Ñ—É–Ω–∫—Ü–∏—é, –Ω–µ –≤—ã–ø–æ–ª–Ω—è—è –µ—ë

    :param text: str - —Ç–µ–∫—Å—Ç –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ generate_quote
    :return: PIL.Image - –æ–±—ä–µ–∫—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    """
    loop = asyncio.get_event_loop()
    return await loop.run_in_executor(
        thread_pool,
        partial(generate_quote, text)
    )

if __name__ == '__main__':
    """ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ """
    executor.start_polling(dp, skip_updates=False)
